<main class="categories-page">
  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between categories-header">
      <div>
        <h1 class="page-title mb-0">Categories</h1>
        <!-- Summary Statistics as subtitle -->
        <div class="flex flex-wrap items-center gap-3 mt-3">
          <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200">
            <i data-lucide="film" class="text-muted" style="width: 16px; height: 16px;"></i>
            <span class="text-sm text-secondary"><%= current_year %> Awards nominees: <strong class="text-primary"><%= @total_nominees %></strong></span>
          </div>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200">
            <i data-lucide="calendar" class="text-muted" style="width: 16px; height: 16px;"></i>
            <span class="text-sm text-secondary">Days until ceremony: <strong class="text-primary"><%= @days_until_ceremony %></strong></span>
          </div>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200">
            <i data-lucide="trophy" class="text-muted" style="width: 16px; height: 16px;"></i>
            <span class="text-sm text-secondary">Category winners left to pick: <strong class="text-primary"><%= @categories_count %></strong></span>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <form class="search-form" role="search" action="<%= categories_path(year: current_year) %>" method="get">
          <i data-lucide="search" class="search-icon"></i>
          <input class="search-input"
                 type="search"
                 name="query"
                 placeholder="Search..."
                 aria-label="Search"
                 value="<%= params[:query] %>">
        </form>

        <% if current_user_admin? %>
          <%= link_to new_category_path(year: current_year), class: "btn-oscar btn-sm" do %>
            <i data-lucide="plus" class="text-muted"></i>
          <% end %>
        <% end %>
      </div>
    </div>

    <% if @categories.any? %>
      <div class="categories-list">
        <% @categories.each do |category| %>
          <% category_movies = category.movies.for_year(current_year).limit(4) %>
          <% if category_movies.any? %>
            <% user_pick = @user_picks[category.id] %>
            <% picking_allowed = Date.today <= Date.new(current_year, 3, 10) %> <%# Example: March 10 %>
            <div class="category-row"
                 data-controller="category-pick"
                 data-category-pick-category-id-value="<%= category.id %>"
                 data-category-pick-year-value="<%= current_year %>"
                 data-category-pick-picking-allowed-value="<%= picking_allowed && current_user.present? %>">
              <!-- Category name column (4/12 columns) -->
              <div class="category-name-column">
                <div class="category-title-row">
                  <div class="category-icon-wrapper">
                    <i data-lucide="trophy" class="category-icon"></i>
                  </div>
                  <div class="category-title-wrapper">
                    <h2 class="category-title"><%= category.name %></h2>
                  </div>
                </div>
                <p class="text-base text-muted m-0 category-count-text"><%= pluralize(category.movies.for_year(current_year).count, 'movie') %></p>
                <% if current_user %>
                  <p class="text-base text-muted m-0 category-count-text">
                    Your nomination:
                    <% if user_pick %>
                      <span data-category-pick-target="nominationText" class="text-secondary font-bold"><%= user_pick.movie.title %></span>
                    <% elsif picking_allowed %>
                      <span data-category-pick-target="nominationText" class="text-muted italic">Pick a movie</span>
                    <% else %>
                      <span data-category-pick-target="nominationText" class="text-muted italic">You missed the deadline for voting</span>
                    <% end %>
                  </p>
                <% end %>
                <p class="text-base text-muted m-0 category-count-text">
                  Won: <span class="text-secondary font-medium">TBD</span>
                </p>
              </div>

              <!-- Movies grid column (8/12 columns) -->
              <div class="category-movies-column">
                <% category_movies.each do |movie| %>
                  <div class="category-movie-card <%= 'selected-pick' if user_pick&.movie_id == movie.id %>"
                       data-category-pick-target="movieCard"
                       data-movie-id="<%= movie.id %>"
                       data-action="click->category-pick#selectMovie"
                       style="cursor: <%= picking_allowed && current_user ? 'pointer' : 'default' %>">
                    <%= render 'movies/movie_card', movie: movie, review: @user_reviews[movie.id], pick_count: @pick_counts[movie.id] || 0 %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="empty-state">
        <div class="empty-icon">
          <i data-lucide="award" class="text-muted"></i>
        </div>
        <h3>No categories found</h3>
        <p>
          <% if params[:query].present? %>
            No results for "<%= params[:query] %>".
          <% else %>
            No categories available yet.
          <% end %>
        </p>
        <% if params[:query].present? %>
          <%= link_to "Clear", categories_path(year: current_year), class: "btn-oscar btn-sm" %>
        <% end %>
      </div>
    <% end %>
  </div>
</main>
