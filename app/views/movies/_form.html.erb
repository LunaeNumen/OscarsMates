<main class="movie-form-page">
  <div class="container mx-auto px-4 py-8">
    <%= form_with model: movie, url: movie.persisted? ? movie_path(movie, year: current_year) : movies_path(year: current_year), class: 'max-w-4xl mx-auto' do |form| %>
      <%= render "shared/errors", object: movie %>
      <%= hidden_field_tag :back_to, @back_to if @back_to.present? %>

      <%# Basic Information Section %>
      <div class="profile-section mb-8">
        <div class="profile-section-header">
          <i data-lucide="film" class="text-muted"></i>
          <h2 class="profile-section-title">Basic Information</h2>
        </div>
        <div class="profile-section-content">
          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <%= form.label :title, "Original Title", class: "block text-sm font-semibold text-slate-900 mb-2" %>
              <%= form.text_field :title, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[var(--oscar-gold)] focus:outline-none focus:ring-1 focus:ring-[var(--oscar-gold)]", placeholder: "Original Title", autofocus: true %>
              <% movie.errors.full_messages_for(:title).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
            <div>
              <%= form.label :english_title, class: "block text-sm font-semibold text-slate-900 mb-2" %>
              <%= form.text_field :english_title, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[var(--oscar-gold)] focus:outline-none focus:ring-1 focus:ring-[var(--oscar-gold)]", placeholder: "English Title" %>
              <% movie.errors.full_messages_for(:english_title).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# Movie Details Section %>
      <div class="profile-section mb-8">
        <div class="profile-section-header">
          <i data-lucide="info" class="text-muted"></i>
          <h2 class="profile-section-title">Movie Details</h2>
        </div>
        <div class="profile-section-content">
          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <%= form.label :runtime, "Runtime (minutes)", class: "block text-sm font-semibold text-slate-900 mb-2" %>
              <%= form.number_field :runtime, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[var(--oscar-gold)] focus:outline-none focus:ring-1 focus:ring-[var(--oscar-gold)]", placeholder: "120" %>
              <% movie.errors.full_messages_for(:runtime).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
            <div>
              <%= form.label :rating, "IMDB Rating", class: "block text-sm font-semibold text-slate-900 mb-2" %>
              <%= form.number_field :rating, step: 0.1, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[var(--oscar-gold)] focus:outline-none focus:ring-1 focus:ring-[var(--oscar-gold)]", placeholder: "7.5" %>
              <% movie.errors.full_messages_for(:rating).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
            <div class="md:col-span-2">
              <%= form.label :genres, class: "block text-sm font-semibold text-slate-900 mb-3" %>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <%= form.collection_check_boxes(:genre_ids, Genre.order(:name), :id, :name) do |checkbox| %>
                  <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:text-slate-900">
                    <%= checkbox.check_box class: "rounded border-slate-300 text-[var(--oscar-gold)] focus:ring-[var(--oscar-gold)]" %>
                    <span><%= checkbox.text %></span>
                  </label>
                <% end %>
              </div>
            </div>
            <div class="md:col-span-2" data-controller="streaming-select">
              <%= form.label :streaming_services_array, "Where to Watch", class: "block text-sm font-semibold text-slate-900 mb-2" %>

              <!-- Selected pills -->
              <div class="flex flex-wrap gap-2 mb-2" data-streaming-select-target="pills"></div>

              <!-- Input field with dropdown arrow -->
              <div class="relative">
                <input type="text"
                       placeholder="Type to search services..."
                       class="w-full"
                       data-streaming-select-target="input"
                       data-action="focus->streaming-select#handleFocus input->streaming-select#handleInput click->streaming-select#handleClick"
                       autocomplete="off">
                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
              </div>

              <!-- Dropdown (fixed positioned to overlay page) -->
              <div class="hidden fixed z-[9999] bg-white border border-slate-200 rounded-lg shadow-xl overflow-hidden"
                   data-streaming-select-target="dropdown"
                   style="max-height: 320px;">
                <div class="overflow-y-auto" style="max-height: 320px;">
                  <% Movie::STREAMING_SERVICES.each do |service| %>
                    <div class="px-4 py-2.5 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors"
                         data-streaming-select-target="option"
                         data-action="click->streaming-select#toggleService">
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox"
                               value="<%= service %>"
                               <%= 'checked' if movie.streaming_services_array.include?(service) %>
                               class="w-4 h-4 rounded border-slate-300 text-[var(--oscar-gold)] focus:ring-[var(--oscar-gold)]">
                        <span class="text-sm text-slate-700"><%= service %></span>
                      </label>
                    </div>
                  <% end %>
                </div>
              </div>

              <% movie.errors.full_messages_for(:where_to_watch).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
            <div class="md:col-span-2">
              <%= form.label :url, "IMDB URL", class: "block text-sm font-semibold text-slate-900 mb-2" %>
              <%= form.text_field :url, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[var(--oscar-gold)] focus:outline-none focus:ring-1 focus:ring-[var(--oscar-gold)]", placeholder: "https://www.imdb.com/title/..." %>
              <% movie.errors.full_messages_for(:url).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
            <div class="md:col-span-2">
              <%= form.label :picture_url, "Poster URL", class: "block text-sm font-semibold text-slate-900 mb-2" %>
              <%= form.text_field :picture_url, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[var(--oscar-gold)] focus:outline-none focus:ring-1 focus:ring-[var(--oscar-gold)]", placeholder: "https://..." %>
              <% movie.errors.full_messages_for(:picture_url).each do |message| %>
                <div class="mt-2 text-sm text-red-600"><%= message %></div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# Nominations Section %>
      <div class="profile-section mb-8">
        <div class="profile-section-header">
          <i data-lucide="trophy" class="text-muted"></i>
          <h2 class="profile-section-title">Nominations</h2>
        </div>
        <div class="profile-section-content">
          <div data-controller="categories-select">
            <%= form.label :categories, class: "block text-sm font-semibold text-slate-900 mb-2" %>
            <%= hidden_field_tag "movie[category_ids][]", "" %>

            <!-- Selected pills -->
            <div class="flex flex-wrap gap-2 mb-2" data-categories-select-target="pills"></div>

            <!-- Input field with dropdown arrow -->
            <div class="relative">
              <input type="text"
                     placeholder="Type to search categories..."
                     class="w-full"
                     data-categories-select-target="input"
                     data-action="focus->categories-select#handleFocus input->categories-select#handleInput click->categories-select#handleClick"
                     autocomplete="off">
              <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
            </div>

            <!-- Dropdown (fixed positioned to overlay page) -->
            <div class="hidden fixed z-[9999] bg-white border border-slate-200 rounded-lg shadow-xl overflow-hidden"
                 data-categories-select-target="dropdown"
                 style="max-height: 320px;">
              <div class="overflow-y-auto" style="max-height: 320px;">
                <% Category.order(:name).each do |category| %>
                  <div class="px-4 py-2.5 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors"
                       data-categories-select-target="option"
                       data-action="click->categories-select#toggleCategory">
                    <label class="flex items-center gap-3 cursor-pointer">
                      <%= check_box_tag "movie[category_ids][]",
                          category.id,
                          movie.category_ids.include?(category.id),
                          class: "w-4 h-4 rounded border-slate-300 text-[var(--oscar-gold)] focus:ring-[var(--oscar-gold)]",
                          data: { name: category.name } %>
                      <span class="text-sm text-slate-700"><%= category.name %></span>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <%# Actions %>
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <% if movie.persisted? %>
          <%= link_to movie_path(movie, year: current_year), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this movie?" }, class: "btn-outline-oscar btn-unwatch" do %>
            <i data-lucide="trash-2"></i>
            <span>Delete Movie</span>
          <% end %>
        <% else %>
          <div></div>
        <% end %>
        <%= form.submit movie.persisted? ? 'Update Movie' : 'Create Movie', class: 'btn-oscar' %>
      </div>
    <% end %>
  </div>
</main>
